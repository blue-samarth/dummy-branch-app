name: CD Pipeline

on:

  push:
    branches: [ main, development, master, production, staging ]
env:
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_PASSWORD }}
  IMAGE_TAG: ${{ github.sha }}
  BRANCH_NAME: ${{ github.ref_name }}
  REPO_NAME: ${{ github.event.repository.name }}


jobs:
    Test-and-build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: '3.11'

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run tests
              env:
                  DATABASE_URL: postgresql+psycopg2://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/${{ secrets.POSTGRES_DB }}
              run: |
                  echo "Running tests..."
                  echo "Pytest has not been configured yet."

    Dockerimg-Build:
        needs: Test-and-build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Set build args for development/staging
              if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/development' || github.ref == 'refs/heads/staging'
              run: |
                  echo "FLASK_ENV=production" >> $GITHUB_ENV
                  echo "HEALTHCHECK_INTERVAL=${{ vars.HEALTHCHECK_INTERVAL_DEVELOPMENT || '30s' }}" >> $GITHUB_ENV
                  echo "HEALTHCHECK_TIMEOUT=${{ vars.HEALTHCHECK_TIMEOUT_DEVELOPMENT || '5s' }}" >> $GITHUB_ENV
                  echo "HEALTHCHECK_RETRIES=${{ vars.HEALTHCHECK_RETRIES_DEVELOPMENT || '3' }}" >> $GITHUB_ENV

            - name: Set build args for production
              if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/production'
              run: |
                  echo "FLASK_ENV=production" >> $GITHUB_ENV
                  echo "HEALTHCHECK_INTERVAL=${{ vars.HEALTHCHECK_INTERVAL_PRODUCTION || '15s' }}" >> $GITHUB_ENV
                  echo "HEALTHCHECK_TIMEOUT=${{ vars.HEALTHCHECK_TIMEOUT_PRODUCTION || '3s' }}" >> $GITHUB_ENV
                  echo "HEALTHCHECK_RETRIES=${{ vars.HEALTHCHECK_RETRIES_PRODUCTION || '5' }}" >> $GITHUB_ENV

            - name: Build Docker image
              run: |
                docker build \
                    --build-arg FLASK_ENV=${{ env.FLASK_ENV || 'production' }} \
                    --build-arg HEALTHCHECK_INTERVAL=${{ env.HEALTHCHECK_INTERVAL || '30s' }} \
                    --build-arg HEALTHCHECK_TIMEOUT=${{ env.HEALTHCHECK_TIMEOUT || '5s' }} \
                    --build-arg HEALTHCHECK_RETRIES=${{ env.HEALTHCHECK_RETRIES || '3' }} \
                    -t ${{ env.REPO_NAME }}:${{ env.IMAGE_TAG }} .


            - name: Save Docker image to file
              run: docker save ${{ env.REPO_NAME }}:${{ env.IMAGE_TAG }} -o image.tar

            - name: Upload image artifact
              uses: actions/upload-artifact@v4
              with:
                  name: built-image
                  path: image.tar
                  compression-level: 6

    Security-Scan:
        needs: Dockerimg-Build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Download image artifact
              uses: actions/download-artifact@v4
              with:
                name: built-image

            - name: Load Docker image
              run: docker load -i image.tar

            - name: Scan Docker image
              uses: aquasecurity/trivy-action@master
              with:
                    image-ref: ${{ env.REPO_NAME }}:${{ env.IMAGE_TAG }}
                    format: 'table'
                    exit-code: '1'
                    severity: 'CRITICAL,HIGH'
                    ignore-unfixed: true

    Push-to-Docker-Hub:
        needs: Security-Scan
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Log in to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ env.DOCKER_HUB_USERNAME }}
                  password: ${{ env.DOCKER_HUB_ACCESS_TOKEN }}

            - name: Setup Build Arguments for development
              if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/development'
              run: |
                  echo "FLASK_ENV=production" >> $GITHUB_ENV
                  echo "POSTGRES_USER=${{ secrets.POSTGRES_USER_DEVELOPMENT }}" >> $GITHUB_ENV
                  echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_DEVELOPMENT }}" >> $GITHUB_ENV
                  echo "POSTGRES_DB=${{ secrets.POSTGRES_DB_DEVELOPMENT }}" >> $GITHUB_ENV
                  echo "DB_VOLUME_PATH=${{ secrets.DB_VOLUME_PATH_DEVELOPMENT }}" >> $GITHUB_ENV

                  echo "HEALTHCHECK_INTERVAL=${{ vars.HEALTHCHECK_INTERVAL_DEVELOPMENT }}" >> $GITHUB_ENV
                  echo "HEALTHCHECK_TIMEOUT=${{ vars.HEALTHCHECK_TIMEOUT_DEVELOPMENT }}" >> $GITHUB_ENV
                  echo "HEALTHCHECK_RETRIES=${{ vars.HEALTHCHECK_RETRIES_DEVELOPMENT }}" >> $GITHUB_ENV

                  echo "APP_CPU_LIMIT=${{ vars.APP_CPU_LIMIT_DEVELOPMENT }}" >> $GITHUB_ENV
                  echo "APP_MEMORY_LIMIT=${{ vars.APP_MEMORY_LIMIT_DEVELOPMENT }}" >> $GITHUB_ENV
                  echo "DB_CPU_LIMIT=${{ vars.DB_CPU_LIMIT_DEVELOPMENT }}" >> $GITHUB_ENV
                  echo "DB_MEMORY_LIMIT=${{ vars.DB_MEMORY_LIMIT_DEVELOPMENT }}" >> $GITHUB_ENV

            - name: Setup Build Arguments for production
              if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/production'
              run: |
                  echo "FLASK_ENV=production" >> $GITHUB_ENV
                  echo "POSTGRES_USER=${{ secrets.POSTGRES_USER_PRODUCTION }}" >> $GITHUB_ENV
                  echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_PRODUCTION }}" >> $GITHUB_ENV
                  echo "POSTGRES_DB=${{ secrets.POSTGRES_DB_PRODUCTION }}" >> $GITHUB_ENV
                  echo "DB_VOLUME_PATH=${{ secrets.DB_VOLUME_PATH_PRODUCTION }}" >> $GITHUB_ENV

                  echo "HEALTHCHECK_INTERVAL=${{ vars.HEALTHCHECK_INTERVAL_PRODUCTION }}" >> $GITHUB_ENV
                  echo "HEALTHCHECK_TIMEOUT=${{ vars.HEALTHCHECK_TIMEOUT_PRODUCTION }}" >> $GITHUB_ENV
                  echo "HEALTHCHECK_RETRIES=${{ vars.HEALTHCHECK_RETRIES_PRODUCTION }}" >> $GITHUB_ENV

                  echo "APP_CPU_LIMIT=${{ vars.APP_CPU_LIMIT_PRODUCTION }}" >> $GITHUB_ENV
                  echo "APP_MEMORY_LIMIT=${{ vars.APP_MEMORY_LIMIT_PRODUCTION }}" >> $GITHUB_ENV
                  echo "DB_CPU_LIMIT=${{ vars.DB_CPU_LIMIT_PRODUCTION }}" >> $GITHUB_ENV
                  echo "DB_MEMORY_LIMIT=${{ vars.DB_MEMORY_LIMIT_PRODUCTION }}" >> $GITHUB_ENV

            - name: Setup Build Arguments for staging
              if: github.ref == 'refs/heads/staging'
              run: |
                  echo "FLASK_ENV=production" >> $GITHUB_ENV
                  echo "POSTGRES_USER=${{ secrets.POSTGRES_USER_STAGING }}" >> $GITHUB_ENV
                  echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD_STAGING }}" >> $GITHUB_ENV
                  echo "POSTGRES_DB=${{ secrets.POSTGRES_DB_STAGING }}" >> $GITHUB_ENV
                  echo "DB_VOLUME_PATH=${{ secrets.DB_VOLUME_PATH_STAGING }}" >> $GITHUB_ENV

                  echo "HEALTHCHECK_INTERVAL=${{ vars.HEALTHCHECK_INTERVAL_STAGING }}" >> $GITHUB_ENV
                  echo "HEALTHCHECK_TIMEOUT=${{ vars.HEALTHCHECK_TIMEOUT_STAGING }}" >> $GITHUB_ENV
                  echo "HEALTHCHECK_RETRIES=${{ vars.HEALTHCHECK_RETRIES_STAGING }}" >> $GITHUB_ENV

                  echo "APP_CPU_LIMIT=${{ vars.APP_CPU_LIMIT_STAGING }}" >> $GITHUB_ENV
                  echo "APP_MEMORY_LIMIT=${{ vars.APP_MEMORY_LIMIT_STAGING }}" >> $GITHUB_ENV
                  echo "DB_CPU_LIMIT=${{ vars.DB_CPU_LIMIT_STAGING }}" >> $GITHUB_ENV
                  echo "DB_MEMORY_LIMIT=${{ vars.DB_MEMORY_LIMIT_STAGING }}" >> $GITHUB_ENV
                

            - name: Push Docker image to Docker Hub
              uses: docker/build-push-action@v4
              with:
                  context: .
                  push: true
                  tags: ${{ env.DOCKER_HUB_USERNAME }}/${{ env.REPO_NAME }}${{ env.BRANCH_NAME }}:${{ env.IMAGE_TAG }},${{ env.DOCKER_HUB_USERNAME }}/${{ env.REPO_NAME }}${{ env.BRANCH_NAME }}:latest
                  build-args: |
                    FLASK_ENV=${{ env.FLASK_ENV }}
                    HEALTHCHECK_INTERVAL=${{ env.HEALTHCHECK_INTERVAL }}
                    HEALTHCHECK_TIMEOUT=${{ env.HEALTHCHECK_TIMEOUT }}
                    HEALTHCHECK_RETRIES=${{ env.HEALTHCHECK_RETRIES }}
        